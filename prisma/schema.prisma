// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User Model
// ============================================
model User {
  id                    String    @id @default(uuid())
  email                 String    @unique
  passwordHash          String    @map("password_hash")
  phoneNumber           String?   @map("phone_number")
  fullName              String    @map("full_name")
  
  // Check-in settings
  checkInFrequencyHours Int       @default(24) @map("check_in_frequency_hours")
  gracePeriodHours      Int       @default(2) @map("grace_period_hours")
  lastCheckInAt         DateTime? @map("last_check_in_at")
  
  // Subscription
  subscriptionStatus    SubscriptionStatus @default(FREE) @map("subscription_status")
  
  // Account status
  isActive              Boolean   @default(true) @map("is_active")
  emailVerified         Boolean   @default(false) @map("email_verified")
  
  // Timestamps
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  
  // Relations
  emergencyContacts     EmergencyContact[]
  checkIns              CheckIn[]
  alerts                Alert[]
  subscriptions         Subscription[]
  
  @@map("users")
  @@index([email])
  @@index([lastCheckInAt])
}

// ============================================
// Emergency Contact Model
// ============================================
model EmergencyContact {
  id                  String   @id @default(uuid())
  userId              String   @map("user_id")
  
  name                String
  phoneNumber         String?  @map("phone_number")
  email               String?
  relationship        String?
  priorityOrder       Int      @map("priority_order")
  notificationMethod  NotificationMethod @default(EMAIL) @map("notification_method")
  
  // Timestamps
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  // Relations
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("emergency_contacts")
  @@index([userId])
  @@index([priorityOrder])
}

// ============================================
// Check-in Model
// ============================================
model CheckIn {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  
  checkedInAt     DateTime @default(now()) @map("checked_in_at")
  ipAddress       String?  @map("ip_address")
  userAgent       String?  @map("user_agent")
  location        Json?    // Optional: {lat, lng, city, country}
  
  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("check_ins")
  @@index([userId])
  @@index([checkedInAt])
}

// ============================================
// Alert Model
// ============================================
model Alert {
  id                  String      @id @default(uuid())
  userId              String      @map("user_id")
  
  triggeredAt         DateTime    @default(now()) @map("triggered_at")
  status              AlertStatus @default(PENDING)
  contactsNotified    Json?       @map("contacts_notified") // Array of contact IDs and notification results
  
  resolvedAt          DateTime?   @map("resolved_at")
  resolutionNote      String?     @map("resolution_note")
  
  // Relations
  user                User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("alerts")
  @@index([userId])
  @@index([status])
  @@index([triggeredAt])
}

// ============================================
// Subscription Model
// ============================================
model Subscription {
  id                    String             @id @default(uuid())
  userId                String             @map("user_id")
  
  planType              SubscriptionPlan   @map("plan_type")
  status                SubscriptionStatus
  
  stripeSubscriptionId  String?            @unique @map("stripe_subscription_id")
  stripeCustomerId      String?            @map("stripe_customer_id")
  
  amount                Decimal            @db.Decimal(10, 2)
  currency              String             @default("USD")
  
  startedAt             DateTime           @default(now()) @map("started_at")
  expiresAt             DateTime?          @map("expires_at")
  cancelledAt           DateTime?          @map("cancelled_at")
  
  // Relations
  user                  User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("subscriptions")
  @@index([userId])
  @@index([status])
}

// ============================================
// Enums
// ============================================
enum SubscriptionStatus {
  FREE
  ACTIVE
  CANCELLED
  EXPIRED
  PAST_DUE
}

enum SubscriptionPlan {
  FREE
  PREMIUM
}

enum NotificationMethod {
  EMAIL
  SMS
  BOTH
}

enum AlertStatus {
  PENDING
  SENT
  RESOLVED
  CANCELLED
  FAILED
}
