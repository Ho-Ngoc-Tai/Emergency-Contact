// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ============================================
// User Model
// ============================================
model User {
  id                    String    @id @default(auto()) @map("_id") @db.ObjectId
  email                 String    @unique
  passwordHash          String    @map("password_hash")
  phoneNumber           String?   @map("phone_number")
  fullName              String    @map("full_name")
  
  // Check-in settings
  checkInFrequencyHours Int       @default(24) @map("check_in_frequency_hours")
  gracePeriodHours      Int       @default(2) @map("grace_period_hours")
  gracePeriodMinutes    Int       @default(10) @map("grace_period_minutes")
  lastCheckInAt         DateTime? @map("last_check_in_at")
  
  // State Machine
  checkinStatus         String    @default("SAFE") @map("checkin_status")
  // SAFE, WARNING, PENDING_ALERT, TRIGGERED
  alertTriggeredAt      DateTime? @map("alert_triggered_at")
  
  // Subscription
  subscriptionStatus    String @default("FREE") @map("subscription_status")
  subscriptionActive    Boolean   @default(false) @map("subscription_active")
  subscriptionExpiresAt DateTime? @map("subscription_expires_at")
  lastPaymentDate       DateTime? @map("last_payment_date")
  
  // Notification settings
  notificationsEnabled  Boolean   @default(true) @map("notifications_enabled")
  lastNotificationSent  DateTime? @map("last_notification_sent")
  fcmToken              String?   @map("fcm_token")
  
  // Emergency settings
  emergencyCallEnabled  Boolean   @default(false) @map("emergency_call_enabled")
  lastEmergencyTrigger  DateTime? @map("last_emergency_trigger")
  lastKnownLocation     String?   @map("last_known_location")
  
  // Heartbeat Monitoring
  lastHeartbeatAt       DateTime? @map("last_heartbeat_at")
  appVersion            String?   @map("app_version")
  deviceInfo            String?   @map("device_info")
  
  // Account status
  isActive              Boolean   @default(true) @map("is_active")
  emailVerified         Boolean   @default(false) @map("email_verified")
  
  // Timestamps
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  
  // Relations
  emergencyContacts     EmergencyContact[]
  checkIns              CheckIn[]
  alerts                Alert[]
  subscriptions         Subscription[]
  notificationQueue     NotificationQueue[]
  alertConfig           AlertConfig?
  
  @@map("users")
}

// ============================================
// Emergency Contact Model
// ============================================
model EmergencyContact {
  id                  String   @id @default(auto()) @map("_id") @db.ObjectId
  userId              String   @db.ObjectId
  
  name                String
  phoneNumber         String?  @map("phone_number")
  email               String?
  relationship        String?
  priorityOrder       Int      @map("priority_order")
  notificationMethod  String @default("EMAIL") @map("notification_method")
  
  // Timestamps
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  // Relations
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("emergency_contacts")
}

// ============================================
// Check-in Model
// ============================================
model CheckIn {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  userId          String   @db.ObjectId
  
  checkedInAt     DateTime @default(now()) @map("checked_in_at")
  ipAddress       String?  @map("ip_address")
  userAgent       String?  @map("user_agent")
  location        String?  // JSON as string for SQLite
  
  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("check_ins")
}

// ============================================
// Alert Model
// ============================================
model Alert {
  id                  String      @id @default(auto()) @map("_id") @db.ObjectId
  userId              String      @db.ObjectId
  
  triggeredAt         DateTime    @default(now()) @map("triggered_at")
  status              String @default("PENDING")
  contactsNotified    String?     @map("contacts_notified") // JSON as string
  
  resolvedAt          DateTime?   @map("resolved_at")
  resolutionNote      String?     @map("resolution_note")
  
  // Relations
  user                User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("alerts")
}

// ============================================
// Subscription Model
// ============================================
model Subscription {
  id                    String             @id @default(auto()) @map("_id") @db.ObjectId
  userId                String             @db.ObjectId
  
  planType              String   @map("plan_type")
  status                String
  
  stripeSubscriptionId  String?            @unique @map("stripe_subscription_id")
  stripeCustomerId      String?            @map("stripe_customer_id")
  
  amount                Float
  currency              String             @default("USD")
  
  startedAt             DateTime           @default(now()) @map("started_at")
  expiresAt             DateTime?          @map("expires_at")
  cancelledAt           DateTime?          @map("cancelled_at")
  
  // Relations
  user                  User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("subscriptions")
}

// ============================================
// Notification Queue Model
// ============================================
model NotificationQueue {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userId      String   @db.ObjectId
  
  type        String   // REMINDER, WARNING, EMERGENCY
  message     String
  scheduledAt DateTime @map("scheduled_at")
  sentAt      DateTime? @map("sent_at")
  status      String   @default("PENDING") // PENDING, SENT, FAILED
  
  // Metadata
  metadata    String?  // JSON as string
  
  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")
  
  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("notification_queue")
  @@index([scheduledAt, status])
}

// ============================================
// Alert Config Model
// ============================================
model AlertConfig {
  id                  String   @id @default(auto()) @map("_id") @db.ObjectId
  userId              String   @unique @db.ObjectId
  
  timeoutHours        Int      @default(24) @map("timeout_hours")
  warningThreshold    Int      @default(1) @map("warning_threshold") // hours before timeout
  gracePeriodMinutes  Int      @default(10) @map("grace_period_minutes")
  
  // Timestamps
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  // Relations
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("alert_configs")
}
